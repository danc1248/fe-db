/*! fe-db - v0.0.1 - 2015-10-31 */(function(){window.FEDB=function(){var a,b,c,d,e,f,g;if(!$)throw new Error("jQuery is required for promises");return b={Number:1,String:2,Enum:3,Table:4},c=function(){function a(){this.tables={}}return a.prototype.setTable=function(a,b,c){var d;return null==c&&(c=[]),d=new f(b,this),this.tables[a]=new g(d,c),this},a.prototype.getTable=function(a){if(void 0===this.tables[a])throw new Error("Unknown table: "+a);return this.tables[a]},a}(),f=function(){function a(a,b){var c,d,e;this.schema=a,this.database=b,this.indexes=[],e=this.schema;for(c in e)d=e[c],"object"!==$.type(d)?this.schema[c]={type:d}:d.unique===!0&&this.indexes.push(c);this.fields=Object.keys(this.schema)}return a.prototype._getIndexes=function(){return this.indexes},a.prototype._validateData=function(a){var b,c,d;for(b=0,c=a.length;c>b;b++)d=a[b],this._validateRow(d);return!0},a.prototype._validateRow=function(a,b){var c,d,e,f;if(this.fields.length!==Object.keys(a).length)throw new Error("unmatched field count for row: "+b);for(f=this.fields,d=0,e=f.length;e>d;d++){if(c=f[d],void 0===a[c])throw new Error("Row not found: "+c+" at "+b);this._validateField(a[c],this.schema[c],c)}return!0},a.prototype._validateField=function(a,c,d){var e,f;if(c.type===b.Number&&"number"===$.type(a))return!0;if(c.type===b.String&&"string"===$.type(a))return!0;if(c.type===b.Enum&&-1!==c.values.indexOf(a))return!0;if(c.type===b.Table&&(f=this.database.getTable(c.target),e=f._getSchema(),e._validateData(a)))return!0;throw new Error("invalid type in data: "+d+": "+a)},a}(),g=function(){function b(a,b){var c,d,e,f;for(this.schema=a,this.data=b,this.schema._validateData(this.data),this.indexes={},f=this.schema._getIndexes(),d=0,e=f.length;e>d;d++)c=f[d],this.indexes[c]=this._addIndex(c)}return b.prototype._getSchema=function(){return this.schema},b.prototype._addIndex=function(a){var b,c,d,e,f,g;for(c={},f=this.data,b=d=0,e=f.length;e>d;b=++d){if(g=f[b],void 0!==c[g[a]])throw new Error("non unique index: "+a);c[g[a]]=b}return c},b.prototype._hasIndex=function(a){return!!this.indexes[a]},b.prototype.getByIndex=function(a,b){var c;return c=this.indexes[a][b],this.data[c]},b.prototype._getData=function(){return this.data},b.prototype.query=function(){var b,c;switch(arguments.length){case 0:case 1:b=new a(null,"*",null);break;case 2:b=new a(arguments[0],"=",arguments[1]);break;default:b=new a(arguments[0],arguments[1],arguments[2])}return c=new d(this,b)},b}(),d=function(){function a(a,b){this.table=a,this.comparison=b,this.queryOrdering=null}return a.prototype.orderBy=function(a,b){return null==b&&(b="ASC"),this.queryOrdering=new e(a,b),this},a.prototype.execute=function(a){var b;return b=$.Deferred(),setTimeout(function(c){return function(){var d,e;return c.comparison._isSingleOperation()&&c.table._hasIndex(c.comparison._getField())?(e=c.table.getByIndex(c.field,a),d=[e]):d=c.table._getData().filter(function(b){return c.comparison._compare(b,a)}),c.queryOrdering&&(d=c.queryOrdering._sortResults(d)),b.resolve(d)}}(this)),b.promise()},a}(),e=function(){function a(a,b){switch(b){case"ASC":case"asc":this.orderByFn=function(b,c){var d,e;return d=b[a],e=c[a],e>d?-1:d>e?1:0};break;case"DESC":case"desc":this.orderByFn=function(b,c){var d,e;return d=b[a],e=c[a],e>d?1:d>e?-1:0};break;default:throw new Error("unknown ordering: "+b)}}return a.prototype._sortResults=function(a){return a.sort(this.orderByFn)},a}(),a=function(){function a(a,b,c){this.field=a,this.operation=b,this.value=c,this.operationFn=null,this.setOperation(this.operation)}return a.prototype._getField=function(){return this.field},a.prototype._isSingleOperation=function(){return"="===this.operation},a.prototype.setOperation=function(a){switch(this.operation=a,this.operation){case"=":this.operationFn=function(a,b){return a===b};break;case"<>":case"!=":this.operationFn=function(a,b){return a!==b};break;case"<":this.operationFn=function(a,b){return b>a};break;case">":this.operationFn=function(a,b){return a>b};break;case"<=":this.operationFn=function(a,b){return b>=a};break;case">=":this.operationFn=function(a,b){return a>=b};break;case"*":this.operationFn=function(){return!0};break;default:throw new Error("operation not supported: "+this.operation)}},a.prototype._compare=function(a){return this.operationFn(a[this.field],this.value)},a}(),{Database:c,Table:g,Query:d,Comparison:a,Data:b}}()}).call(this);